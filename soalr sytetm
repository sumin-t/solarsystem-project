import base64
from io import BytesIO
from dataclasses import dataclass
import streamlit as st

# â”€â”€ OpenAI í´ë¼ì´ì–¸íŠ¸ (ìµœì‹  SDK ê¸°ì¤€) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1) í™˜ê²½ë³€ìˆ˜ OPENAI_API_KEY ë˜ëŠ”
# 2) .streamlit/secrets.toml ì˜ openai_api_key ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
try:
    from openai import OpenAI
    client = OpenAI(api_key=st.secrets.get("openai_api_key", None))
except Exception:
    # êµ¬ë²„ì „ í˜¸í™˜ (í•„ìš” ì‹œ)
    from openai import OpenAI
    client = OpenAI(api_key=None)

# â”€â”€ UI êµ¬ì„± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.set_page_config(page_title="ë‚˜ë§Œì˜ í–‰ì„± ê·¸ë¦¼ ë§Œë“¤ê¸°", layout="wide")
st.title("ë‚˜ë§Œì˜ í–‰ì„± ê·¸ë¦¼ ë§Œë“¤ê¸°")
st.caption("Streamlit ì„œë²„ì—ì„œ OpenAI ì´ë¯¸ì§€ APIë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤. ë¸Œë¼ìš°ì €ì— í‚¤ê°€ ë…¸ì¶œë˜ì§€ ì•Šì•„ìš”.")

# (ì„ íƒ) ìˆ˜ë™ í‚¤ ì…ë ¥: ë¡œì»¬ í…ŒìŠ¤íŠ¸ìš©. ë°°í¬ ì‹œì—ëŠ” st.secrets/í™˜ê²½ë³€ìˆ˜ ì‚¬ìš© ê¶Œì¥
with st.expander("ğŸ”‘ API í‚¤ ì§ì ‘ ì…ë ¥(ì„ íƒ)"):
    manual_key = st.text_input("OpenAI API Key (ì„ íƒ)", type="password", placeholder="sk-...")
    if manual_key:
        client = OpenAI(api_key=manual_key)

@dataclass
class Planet:
    label: str
    value: str
    style_hint: str

PLANETS = [
    Planet("ìˆ˜ì„± (Mercury)", "Mercury", "ì‘ê³  íšŒìƒ‰ë¹›, ìš´ì„ í¬ë ˆì´í„°, ëŒ€ê¸° í¬ë°•, íƒœì–‘ì— ë§¤ìš° ê°€ê¹Œì›€"),
    Planet("ê¸ˆì„± (Venus)", "Venus", "ë‘êº¼ìš´ í™©ë°±ìƒ‰ êµ¬ë¦„, ë§¤ìš° ëœ¨ê±°ì›€, ë¶€ë“œëŸ¬ìš´ ê´‘ì±„, ì•½í•œ í‘œë©´ ë””í…Œì¼"),
    Planet("ì§€êµ¬ (Earth)", "Earth", "í‘¸ë¥¸ ë°”ë‹¤, í•˜ì–€ êµ¬ë¦„, ì´ˆë¡ê³¼ ê°ˆìƒ‰ ëŒ€ë¥™, ìƒëª… ë„˜ì¹˜ëŠ” ëŠë‚Œ"),
    Planet("í™”ì„± (Mars)", "Mars", "ì ê°ˆìƒ‰ ì‚¬ë§‰, ê±°ëŒ€í•œ í™”ì‚°ê³¼ í˜‘ê³¡, ì—·ì€ ëŒ€ê¸°, ë¨¼ì§€í­í’ ê°€ëŠ¥"),
    Planet("ëª©ì„± (Jupiter)", "Jupiter", "ê°ˆìƒ‰ê³¼ í¬ë¦¼ìƒ‰ ì¤„ë¬´ëŠ¬, ê±°ëŒ€í•œ ë¶‰ì€ ì  í­í’, ê±°ëŒ€ ê°€ìŠ¤í–‰ì„±"),
    Planet("í† ì„± (Saturn)", "Saturn", "ì•„ë¦„ë‹¤ìš´ ê³ ë¦¬, í™©ê¸ˆë¹› ê°€ìŠ¤ì¸µ, ì„¬ì„¸í•œ ê³ ë¦¬ êµ¬ì¡° ë””í…Œì¼"),
    Planet("ì²œì™•ì„± (Uranus)", "Uranus", "ë°ì€ ì²­ë¡ìƒ‰, ì˜…ì€ êµ¬ë¦„, ì˜†ìœ¼ë¡œ ëˆ„ìš´ ìì „ì¶•, ì°¨ë¶„í•œ ëŠë‚Œ"),
    Planet("í•´ì™•ì„± (Neptune)", "Neptune", "ì§„í•œ íŒŒë€ìƒ‰, ê°•í•œ ë°”ëŒ, ì–´ë‘ìš´ ì  í­í’ ê°€ëŠ¥, ì°¨ê°‘ê³  ê¹Šì€ ë°”ë‹¤ ëŠë‚Œ"),
]

col_left, col_right = st.columns([1.1, 1])

with col_left:
    p = st.selectbox("í–‰ì„± ì„ íƒ", PLANETS, format_func=lambda x: x.label)
    user_prompt = st.text_area(
        "í”„ë¡¬í”„íŠ¸",
        placeholder="ì˜ˆ) ì•„ì´ë“¤ì´ ë°”ë¼ë³´ëŠ” ë§Œí™”í’, ë³„ë¹›ì´ ë°˜ì§ì´ëŠ” ë°°ê²½, ë”°ëœ»í•œ ìƒ‰ê°",
        height=120,
    )
    c1, c2 = st.columns(2)
    with c1:
        style = st.selectbox(
            "ìŠ¤íƒ€ì¼ (ì„ íƒ)",
            ["ìë™", "ìˆ˜ì±„í™”", "ë§Œí™”í’", "í”½ì…€ì•„íŠ¸", "ìœ í™”", "ë¦¬ì–¼ë¦¬ì¦˜", "í”Œë« ì¼ëŸ¬ìŠ¤íŠ¸"],
            index=0,
        )
    with c2:
        size = st.selectbox("ì´ë¯¸ì§€ í¬ê¸°", ["1024x1024", "1024x1792", "1792x1024"], index=0)

    generate = st.button("ğŸ¨ ê·¸ë¦¼ ë§Œë“¤ê¸°", type="primary", use_container_width=True)

with col_right:
    preview = st.container(border=True)
    status = st.empty()

# â”€â”€ í”„ë¡¬í”„íŠ¸ ë¹Œë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def build_prompt(planet: Planet, user_prompt: str, style: str) -> str:
    style_part = "" if style == "ìë™" else f" (ìŠ¤íƒ€ì¼: {style})"
    return (
        f"{planet.value} í–‰ì„±ì˜ íŠ¹ì§•ì„ ë°˜ì˜í•œ ì¼ëŸ¬ìŠ¤íŠ¸{style_part}. "
        f"í–‰ì„± ë¬˜ì‚¬ íŒíŠ¸: {planet.style_hint}. "
        f"ì¶”ê°€ ì¡°ê±´: {user_prompt or 'ìì—°ìŠ¤ëŸ¬ìš´ ìš°ì£¼ ë°°ê²½, ë†’ì€ í•´ìƒë„, ë””í…Œì¼ ì„ ëª…'}."
    )

# â”€â”€ ì´ë¯¸ì§€ ìƒì„± í˜¸ì¶œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def generate_image(prompt: str, size: str):
    # ìµœì‹  SDKì˜ ì´ë¯¸ì§€ ìƒì„± (gpt-image-1)
    # ë°˜í™˜ í˜•ì‹ì´ base64ì¸ ê²½ìš°ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤.
    try:
        result = client.images.generate(
            model="gpt-image-1",
            prompt=prompt,
            size=size,
        )
        # SDK ê²°ê³¼ì—ì„œ base64 ë°ì´í„° ì¶”ì¶œ
        b64 = result.data[0].b64_json  # type: ignore[attr-defined]
        return base64.b64decode(b64)
    except Exception as e:
        raise RuntimeError(str(e))

# â”€â”€ ì‹¤í–‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if generate:
    if not (client and (getattr(client, "api_key", None) or manual_key or st.secrets.get("openai_api_key"))):
        status.error("API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ìƒë‹¨ì˜ API í‚¤ ì…ë ¥ ë˜ëŠ” secrets/í™˜ê²½ë³€ìˆ˜ë¡œ ì„¤ì •í•˜ì„¸ìš”.")
    else:
        full_prompt = build_prompt(p, user_prompt, style)
        status.info("ì´ë¯¸ì§€ ìƒì„± ì¤‘â€¦ 10~20ì´ˆ ê±¸ë¦´ ìˆ˜ ìˆì–´ìš”.")
        try:
            img_bytes = generate_image(full_prompt, size)
            # ë¯¸ë¦¬ë³´ê¸° + ë‹¤ìš´ë¡œë“œ
            with preview:
                st.image(img_bytes, caption="ìƒì„±ëœ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°", use_column_width=True)
                buf = BytesIO(img_bytes)
                st.download_button(
                    "ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ",
                    data=buf,
                    file_name=f"{p.value.lower()}_{size.replace('x','-')}.png",
                    mime="image/png",
                    use_container_width=True,
                )
            status.success("ì™„ë£Œ!")
        except Exception as e:
            status.error(f"ìƒì„± ì‹¤íŒ¨: {e}")
else:
    with preview:
        st.markdown("ğŸª ì˜¤ë¥¸ìª½ ì˜ì—­ì— ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤.")
